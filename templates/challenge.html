<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ challenge.title }} - PyQuest</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="logo">üêç</span>
                <span class="brand-text">PyQuest</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/challenge" class="nav-link active">Today's Challenge</a>
                <a href="/curriculum" class="nav-link">Curriculum</a>
                <a href="/progress" class="nav-link">Progress</a>
                <a href="/resources" class="nav-link">Resources</a>
            </div>
        </div>
    </nav>

    <main class="main-content challenge-page">
        <div class="container-wide">
            <div class="challenge-layout">
                <!-- Left Panel: Instructions -->
                <div class="challenge-instructions">
                    <div class="challenge-header-section">
                        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
                        <h1>{{ challenge.title }}</h1>
                        <div class="challenge-meta-bar">
                            <span class="difficulty-badge {{ challenge.difficulty }}">{{ challenge.difficulty }}</span>
                            <span class="meta-item">‚è±Ô∏è {{ challenge.time_estimate }}</span>
                            <span class="meta-item">üìÖ Week {{ challenge.week }}, Day {{ challenge.day }}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>üìñ Description</h2>
                        <div class="description-content markdown-content">{{ challenge.description | markdown | safe }}</div>
                    </div>

                    <div class="section">
                        <h2>üéØ Instructions</h2>
                        <div class="instructions-content markdown-content">{{ challenge.instructions | markdown | safe }}</div>
                    </div>

                    <div class="section hints-section" id="hintsSection" style="display: none;">
                        <h2>üí° Hints</h2>
                        <div id="hintsContainer"></div>
                        <button class="btn btn-secondary" id="showHintBtn" onclick="showNextHint()">
                            Show Hint
                        </button>
                    </div>

                    {% if challenge.learning_resources %}
                    <div class="section">
                        <h2>üìö Learning Resources</h2>
                        <ul class="resources-list">
                            {% for resource in challenge.learning_resources %}
                            <li>{{ resource }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Panel: Code Editor -->
                <div class="challenge-workspace">
                    <div class="editor-header">
                        <h3>üíª Code Editor</h3>
                        <div class="editor-actions">
                            <button class="btn btn-small" onclick="resetCode()">üîÑ Reset</button>
                            <button class="btn btn-small btn-secondary" onclick="runTests()">‚ñ∂Ô∏è Run Tests</button>
                            <button class="btn btn-small btn-primary" onclick="submitSolution()">‚úì Submit</button>
                        </div>
                    </div>

                    <div class="code-editor">
                        <textarea id="codeEditor" spellcheck="false">{{ challenge.starter_code }}</textarea>
                    </div>

                    <div class="timer-display" id="timerDisplay">
                        Time: <span id="timerValue">00:00</span>
                    </div>

                    <div class="test-results" id="testResults" style="display: none;">
                        <h3>Test Results</h3>
                        <div id="resultsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Store challenge data
        const challengeData = {{ challenge|tojson }};
        let currentHintIndex = 0;
        let startTime = Date.now();
        let timerInterval;

        // Start timer
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timerValue').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // Show hints section
        document.getElementById('hintsSection').style.display = 'block';

        function showNextHint() {
            if (currentHintIndex < challengeData.hints.length) {
                const hint = challengeData.hints[currentHintIndex];
                const hintDiv = document.createElement('div');
                hintDiv.className = 'hint-item';
                hintDiv.innerHTML = `<strong>Hint ${currentHintIndex + 1}:</strong> ${hint}`;
                document.getElementById('hintsContainer').appendChild(hintDiv);
                currentHintIndex++;
                
                if (currentHintIndex >= challengeData.hints.length) {
                    document.getElementById('showHintBtn').style.display = 'none';
                }
            }
        }

        function resetCode() {
            document.getElementById('codeEditor').value = challengeData.starter_code;
        }

        async function runTests() {
            const code = document.getElementById('codeEditor').value;
            const resultsDiv = document.getElementById('testResults');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading">Running tests...</div>';
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge_id: challengeData.id,
                        code: code,
                        time_spent: Math.floor((Date.now() - startTime) / 60000)
                    })
                });
                
                const result = await response.json();
                displayResults(result);
            } catch (error) {
                resultsContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function submitSolution() {
            await runTests();
        }

        function displayResults(result) {
            const resultsContent = document.getElementById('resultsContent');
            
            if (result.error) {
                resultsContent.innerHTML = `
                    <div class="test-result error">
                        <h4>‚ùå Error</h4>
                        <pre>${result.error}</pre>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="test-summary ${result.passed ? 'success' : 'failure'}">
                    <h4>${result.passed ? '‚úÖ All tests passed!' : '‚ùå Some tests failed'}</h4>
                    <p>Passed: ${result.passed_tests}/${result.total_tests}</p>
                    <p>Execution time: ${result.execution_time.toFixed(3)}s</p>
                </div>
            `;
            
            result.test_results.forEach(test => {
                html += `
                    <div class="test-result ${test.passed ? 'success' : 'failure'}">
                        <h4>${test.passed ? '‚úÖ' : '‚ùå'} ${test.description}</h4>
                        ${!test.passed ? `
                            <p><strong>Expected:</strong> ${JSON.stringify(test.expected)}</p>
                            <p><strong>Got:</strong> ${JSON.stringify(test.actual)}</p>
                            ${test.error ? `<p class="error-msg">${test.error}</p>` : ''}
                        ` : ''}
                    </div>
                `;
            });
            
            if (result.passed) {
                html += `
                    <div class="success-message">
                        <h3>üéâ Congratulations!</h3>
                        <p>You've completed this challenge!</p>
                        <a href="/" class="btn btn-primary">Return to Dashboard</a>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = html;
        }

        // Add code editor enhancements
        const editor = document.getElementById('codeEditor');
        
        // Tab key support
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
            }
        });

        // Start the timer
        startTimer();
    </script>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
