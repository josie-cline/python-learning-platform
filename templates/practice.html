<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Sandbox - PyQuest</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- CodeMirror for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-ocean.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="logo">üêç</span>
                <span class="brand-text">PyQuest</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/challenge" class="nav-link">Today's Challenge</a>
                <a href="/browse" class="nav-link">Browse</a>
                <a href="/practice" class="nav-link active">Practice</a>
                <a href="/tools" class="nav-link">Tools</a>
                <a href="/progress" class="nav-link">Progress</a>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span class="theme-toggle-icon">üåì</span>
                    <span class="theme-toggle-text">Dark Mode</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container-wide">
            <h1>üéÆ Practice Sandbox</h1>
            <p class="page-subtitle">AI-generated unique challenges based on topics you choose</p>
            <div class="ai-badge">‚ú® Powered by AI - Every challenge is unique!</div>

            <div class="practice-layout">
                <!-- Filters Sidebar -->
                <div class="practice-filters">
                    <h2>üéØ Filter Practice</h2>
                    
                    <div class="filter-section">
                        <h3>Difficulty</h3>
                        <div class="filter-group">
                            <label><input type="radio" name="difficulty" value=""> All</label>
                            <label><input type="radio" name="difficulty" value="beginner"> Beginner</label>
                            <label><input type="radio" name="difficulty" value="intermediate"> Intermediate</label>
                            <label><input type="radio" name="difficulty" value="advanced"> Advanced</label>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3>Topics to Practice</h3>
                        <div class="filter-group">
                            <label><input type="checkbox" name="topics" value="functions"> Functions</label>
                            <label><input type="checkbox" name="topics" value="variables"> Variables</label>
                            <label><input type="checkbox" name="topics" value="strings"> Strings</label>
                            <label><input type="checkbox" name="topics" value="loops"> Loops</label>
                            <label><input type="checkbox" name="topics" value="conditions"> If/Else</label>
                            <label><input type="checkbox" name="topics" value="lists"> Lists</label>
                            <label><input type="checkbox" name="topics" value="dictionaries"> Dictionaries</label>
                            <label><input type="checkbox" name="topics" value="math"> Math Operations</label>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="getRandomChallenge()">
                        üé≤ Get Random Challenge
                    </button>

                    <div class="practice-tips">
                        <h3>üí° Practice Tips</h3>
                        <ul>
                            <li>Select topics you're uncomfortable with</li>
                            <li>Start with beginner difficulty</li>
                            <li>Each challenge is unique!</li>
                            <li>Try solving without hints first</li>
                            <li>Practice makes perfect!</li>
                        </ul>
                    </div>
                    
                    <div class="practice-tips">
                        <h3>üîë Enable AI Generation</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary);">
                            To unlock unlimited unique challenges, add your OpenAI API key to the .env file. 
                            <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary);">Get a key here</a>
                        </p>
                    </div>
                </div>

                <!-- Challenge Display -->
                <div class="practice-content">
                    <div id="practiceChallenge" class="practice-empty">
                        <div class="empty-state-large">
                            <div class="empty-icon">‚ú®</div>
                            <h2>Ready for AI-Generated Practice?</h2>
                            <p>Select your difficulty and topics, then click "Get Random Challenge"</p>
                            <p class="empty-hint">AI will create a unique problem just for you!</p>
                            <p class="empty-hint" style="margin-top: 1rem; font-size: 0.85rem;">
                                üí° Tip: Add OPENAI_API_KEY to your .env file for AI generation
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 PyQuest - Your Path to Python Mastery üêç</p>
        </div>
    </footer>

    <script>
        async function getRandomChallenge() {
            const difficulty = document.querySelector('input[name="difficulty"]:checked')?.value || '';
            const topicsCheckboxes = document.querySelectorAll('input[name="topics"]:checked');
            const topics = Array.from(topicsCheckboxes).map(cb => cb.value);

            // Show loading state
            displayLoading();

            // Build query string
            const params = new URLSearchParams();
            if (difficulty) params.append('difficulty', difficulty);
            topics.forEach(topic => params.append('topics', topic));

            try {
                const response = await fetch(`/api/random-challenge?${params}`);
                const challenge = await response.json();

                if (challenge.error) {
                    displayError(challenge.error, challenge.message, challenge.instructions);
                } else {
                    displayChallenge(challenge);
                }
            } catch (error) {
                displayError('Failed to generate challenge', 'Please try again or check your connection.');
            }
        }

        function displayLoading() {
            const container = document.getElementById('practiceChallenge');
            container.className = 'practice-loading';
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner">‚ú®</div>
                    <h2>Generating Your Challenge...</h2>
                    <p>AI is creating a unique problem just for you!</p>
                    <div class="loading-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </div>
                </div>
            `;
        }

        let currentChallenge = null;

        function displayChallenge(challenge) {
            currentChallenge = challenge;
            const container = document.getElementById('practiceChallenge');
            container.className = 'practice-challenge-display';
            container.innerHTML = `
                <div class="practice-header">
                    <div>
                        <h2>${challenge.title}</h2>
                        <p class="challenge-topic">${challenge.topic}</p>
                    </div>
                    <div class="practice-meta">
                        <span class="difficulty-badge ${challenge.difficulty}">${challenge.difficulty}</span>
                        <span class="meta-item">‚è±Ô∏è ${challenge.time_estimate}</span>
                        ${challenge.week === 0 ? '<span class="ai-generated-badge">‚ú® AI Generated</span>' : `<span class="meta-item">üìÖ Week ${challenge.week}, Day ${challenge.day}</span>`}
                    </div>
                </div>

                <div class="practice-description markdown-content">
                    ${challenge.description || 'No description available'}
                </div>

                <div class="practice-instructions markdown-content">
                    <h3>üìù Instructions:</h3>
                    ${challenge.instructions || 'No instructions available'}
                </div>

                <div class="practice-code-section">
                    <div class="code-editor">
                        <div class="code-editor-header">
                            <div class="code-editor-dots">
                                <span class="code-editor-dot red"></span>
                                <span class="code-editor-dot yellow"></span>
                                <span class="code-editor-dot green"></span>
                            </div>
                            <div class="code-editor-title">
                                <span class="file-icon">üêç</span>
                                practice_solution.py
                            </div>
                            <div class="code-editor-info">Python 3.11</div>
                        </div>
                        <div class="code-editor-body">
                            <textarea id="practiceCodeEditor" spellcheck="false">${challenge.starter_code || '# Write your code here\ndef solution():\n    pass'}</textarea>
                        </div>
                        <div class="code-editor-footer">
                            <div class="footer-left">
                                <span class="footer-item">üêç Python</span>
                                <span class="footer-item">UTF-8</span>
                            </div>
                            <div class="footer-right">
                                <span class="footer-item" id="practiceCursorPosition">Ln 1, Col 1</span>
                                <span class="footer-item" id="practiceLineCount">0 lines</span>
                                <button class="btn btn-small btn-secondary" onclick="resetPracticeCode()" style="margin-left: 1rem;">üîÑ Reset</button>
                                <button class="btn btn-small btn-primary" onclick="runPracticeTests()">‚ñ∂Ô∏è Run Tests</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="practiceTestResults"></div>
                </div>

                <div class="practice-actions">
                    ${challenge.week !== 0 ? `
                        <a href="/challenge?week=${challenge.week}&day_num=${challenge.day}" class="btn btn-secondary btn-small">
                            üìö View Full Lesson
                        </a>
                    ` : ''}
                    <button class="btn ${challenge.week === 0 ? 'btn-primary' : 'btn-secondary'}" onclick="getRandomChallenge()">
                        üé≤ ${challenge.week === 0 ? 'Generate Another' : 'Another Random Challenge'}
                    </button>
                </div>
            `;
        }

        function resetPracticeCode() {
            const editor = document.getElementById('practiceCodeEditor');
            if (editor && currentChallenge) {
                editor.value = currentChallenge.starter_code || '# Write your code here\n';
            }
        }

        async function runPracticeTests() {
            const code = document.getElementById('practiceCodeEditor').value;
            const resultsDiv = document.getElementById('practiceTestResults');
            
            if (!currentChallenge || !currentChallenge.id) {
                resultsDiv.innerHTML = '<div class="test-result failure">No challenge loaded</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="test-running">üîÑ Running tests...</div>';
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge_id: currentChallenge.id,
                        code: code,
                        time_spent: 0
                    })
                });
                
                const result = await response.json();
                
                // Display detailed results with output
                let html = `
                    <div class="test-summary ${result.passed ? 'success' : 'failure'}">
                        <h4>${result.passed ? '‚úÖ All tests passed!' : '‚ùå Some tests failed'}</h4>
                        <p>Passed: ${result.passed_tests}/${result.total_tests}</p>
                    </div>
                `;
                
                if (result.test_results) {
                    result.test_results.forEach(test => {
                        html += `
                            <div class="test-result ${test.passed ? 'success' : 'failure'}">
                                <h4>${test.passed ? '‚úÖ' : '‚ùå'} Test ${test.test_number}</h4>
                                
                                ${test.output ? `
                                    <div class="output-section">
                                        <strong>üì§ Your Code Output:</strong>
                                        <pre class="code-output">${test.output}</pre>
                                    </div>
                                ` : ''}
                                
                                <div class="test-comparison">
                                    <p><strong>Expected:</strong> <code>${JSON.stringify(test.expected)}</code></p>
                                    <p><strong>Got:</strong> <code>${JSON.stringify(test.actual)}</code></p>
                                </div>
                                
                                ${!test.passed && test.error ? `
                                    <div class="error-help">
                                        <pre class="error-details">${test.error}</pre>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                
                if (result.passed) {
                    html += `
                        <div class="success-message">
                            <p>üéâ Perfect! Try another challenge to keep learning.</p>
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-result failure">
                        <h3>Error running tests</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function displayError(title, message, instructions) {
            const container = document.getElementById('practiceChallenge');
            container.className = 'practice-empty';
            
            let instructionsHTML = '';
            if (instructions && Array.isArray(instructions)) {
                instructionsHTML = '<ol class="error-instructions">' +
                    instructions.map(i => `<li>${i}</li>`).join('') +
                    '</ol>';
            }
            
            container.innerHTML = `
                <div class="empty-state-large">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <h2>${title || 'Error'}</h2>
                    <p>${message || 'Something went wrong'}</p>
                    ${instructionsHTML}
                    <button class="btn btn-primary" onclick="getRandomChallenge()">Try Again</button>
                </div>
            `;
        }
    </script>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // Initialize CodeMirror for practice editor when challenge is displayed
        let practiceEditor = null;
        
        // Override displayChallenge to initialize CodeMirror
        const originalDisplayChallenge = displayChallenge;
        displayChallenge = function(challenge) {
            originalDisplayChallenge(challenge);
            
            // Wait for DOM to update, then initialize CodeMirror
            setTimeout(() => {
                const textarea = document.getElementById('practiceCodeEditor');
                if (textarea && typeof CodeMirror !== 'undefined') {
                    practiceEditor = CodeMirror.fromTextArea(textarea, {
                        mode: 'python',
                        theme: 'material-ocean',
                        lineNumbers: true,
                        indentUnit: 4,
                        tabSize: 4,
                        indentWithTabs: false,
                        lineWrapping: false,
                        matchBrackets: true,
                        autoCloseBrackets: true,
                        styleActiveLine: true,
                        highlightSelectionMatches: true,
                        viewportMargin: Infinity
                    });
                    
                    // Update status bar on cursor movement
                    practiceEditor.on('cursorActivity', () => {
                        const cursor = practiceEditor.getCursor();
                        const cursorPosEl = document.getElementById('practiceCursorPosition');
                        if (cursorPosEl) {
                            cursorPosEl.textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
                        }
                    });
                    
                    // Update line count on change
                    practiceEditor.on('change', () => {
                        const lineCountEl = document.getElementById('practiceLineCount');
                        if (lineCountEl) {
                            lineCountEl.textContent = `${practiceEditor.lineCount()} lines`;
                        }
                    });
                    
                    // Initial status update
                    const lineCountEl = document.getElementById('practiceLineCount');
                    if (lineCountEl) {
                        lineCountEl.textContent = `${practiceEditor.lineCount()} lines`;
                    }
                }
            }, 100);
        };
        
        // Update helper functions for practice editor
        function resetPracticeCode() {
            if (currentChallenge && confirm('Reset code to starter template?')) {
                const starterCode = currentChallenge.starter_code || '# Write your code here\ndef solution():\n    pass';
                if (practiceEditor) {
                    practiceEditor.setValue(starterCode);
                }
            }
        }
        
        function runPracticeTests() {
            if (!practiceEditor) {
                alert('Code editor not ready. Try generating a challenge first.');
                return;
            }
            
            const code = practiceEditor.getValue();
            const resultsDiv = document.getElementById('practiceTestResults');
            
            resultsDiv.innerHTML = `
                <div class="test-result success" style="margin-top: 1rem;">
                    <h4>‚úÖ Code Ready!</h4>
                    <p>Your code:</p>
                    <pre style="background: #0d1117; padding: 1rem; border-radius: 0.5rem; color: #e6edf3; overflow-x: auto;">${code}</pre>
                    <p style="margin-top: 1rem;"><em>Note: Practice mode shows your code. Full test execution coming soon!</em></p>
                </div>
            `;
        }
    </script>
</body>
</html>
